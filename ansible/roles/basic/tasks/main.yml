- name: "installing software"
  apt: pkg={{ item }} state=installed
  with_items:
    - vim
    - tmux
    - screen
    - tkdiff
    - dstat

- name: "adding keyfile"
  shell: |
    cp /proj/skyhook-PG0/kat_stuff/id_rsa "{{ local_home }}/.ssh"
    sudo chmod 0600 "{{ local_home }}/.ssh/id_rsa"

- name: "copy setup files"
  copy:
    src: "{{ item }}"
    dest: "{{ local_home }}"
    mode: '0644'
  with_items:
    - ./files/format-device.sh

- name: "running format device"
  shell: sh format-device.sh {{ format_username }} {{ format_device }} ;
  ignore_errors: yes

- name: "clone skyhook repo"
  shell: |
    cd "/mnt/{{ format_device }}" ;
    git clone https://github.com/uccross/skyhook-ceph.git ;

- name: "setup skyhook repo"
  shell: |
    cd "/mnt/{{ format_device }}/skyhook-ceph" ;
    git checkout {{ skyhook_branch }} ;

- name: "running install-deps"
  shell: |
    cd "/mnt/{{ format_device }}/skyhook-ceph" ;
    ./install-deps.sh ;

- name: "running do_cmake"
  shell: |
    cd "/mnt/{{ format_device }}/skyhook-ceph" ;
    ./do_cmake.sh ;

- name: "make run-query"
  shell: |
    cd "/mnt/{{ format_device }}/skyhook-ceph/build" ;
    make cls_tabular ;
